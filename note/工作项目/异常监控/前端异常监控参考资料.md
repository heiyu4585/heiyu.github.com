## 前端异常监控参考资料

### 文章链接
* JavaScript 异常档案,  https://saijs.github.io/wiki/
* 从无到有 <前端异常监控系统 > 落地 , http://web.jobbole.com/93498/
* 如何做前端异常监控？ , https://www.zhihu.com/question/29953354
* 构建可靠的前端异常监控服务 - 采集篇 ,https://juejin.im/entry/57f9cdec7db2a200594c02ec
* 前端代码异常日志收集与监控 , https://www.cnblogs.com/hustskyking/p/fe-monitor.html
* 构建web前端异常监控系统–FdSafe ,http://www.aliued.cn/2012/10/27/%E6%9E%84%E5%BB%BAweb%E5%89%8D%E7%AB%AF%E5%BC%82%E5%B8%B8%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F-fdsafe.html
* 前端异常监控，http://kouyun.me/2017/04/07/%E5%89%8D%E7%AB%AF%E5%BC%82%E5%B8%B8%E7%9B%91%E6%8E%A7/
* JSTracker：前端异常数据采集，http://taobaofed.org/blog/2015/10/28/jstracker-how-to-collect-data/
* GMTC 大前端时代前端监控的最佳实践，http://jm.taobao.org/2018/06/29/%E5%A4%A7%E5%89%8D%E7%AB%AF%E6%97%B6%E4%BB%A3%E5%89%8D%E7%AB%AF%E7%9B%91%E6%8E%A7%E7%9A%84%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/
* FunDebug 文档，https://docs.fundebug.com/notifier/javascript/type/resource.html

### 当前行业内解决方案对比

##### 方案一
* 项目名称：Badjs
* 项目类型：开源
* 项目优点：
	* 开源项目，代码可控
	* 有服务器部署整套解决方案
* 项目缺点：
	* 仅支持原生 js 异常监控
	* 针对 vue 、小程序等业务场景需要额外定制化开发
	* 定制化开发难度较大，已做过部分尝试

##### 方案二
* 项目名称：Sentry
* 项目类型：开源
* 项目优点：
	* 开源项目，代码可控
	* 有服务器部署整体解决方案
	* 支持 vue 业务场景
* 项目缺点：
	* 对小程序等业务场景需要额外的定制化开发
	* 定制化开发成本较大，可借鉴Badjs

##### 方案三
* 项目名称：阿里云ARMS
* 项目类型：商业
* 项目优点：
	* 商业项目，有配套的服务器解决方案
	* 进支持原生 js 异常监控
* 项目缺点：
	* 针对 vue 、小程序等业务场景支持程度不高

##### 方案四
* 项目名称：Fundebug
* 项目类型：商业
* 项目优点：
	* 兼容 IE6+
	* 支持当前常见的前端业务场景，vue、小程序等
	* 商业项目，有配套的服务器解决方案
* 项目缺点：
	* 用户隐私及敏感功能容易暴露，如支付功能

##### 小结
* 根据之前的开发及部署经验，体会较深的是如果直接使用第三方开源项目，当有需要定制化时，仍然需要花费时间去了解其基本运行原理，同时会受限于当前采用的开源项目的设计思想。会花费与自研相当甚至更多的时间去理解开源项目源码，同时还不能保证是否能够达到自身业务的需要。
* 完全采用商业项目，除去经济成本外，更多比较担心部分设计用户隐私的敏感数据是否会被第三方收集。
* 建议：
	* 1）可以先暂时采用第三方监控，找出当前业务中在生产环境中产生的未知前端异常信息，方便团队即时修复问题。
	* 2）同时加紧重构后的自研前端异常监控系统，同时也能借鉴部分第三方监控的功能设计，待开发完成，无缝切换即可。
	


### 项目目标

* 意义1：

	页面的异常有很多种，HTML 标签异常，CSS 展现异常，样式、图片、脚本文件的请求异常、脚本执行异常。有些涉及用户自身的网络环境，如网速很慢、被运营商强行注入标签或脚本，我们很难规避；有些仅仅是展示上的问题，如文本和按钮没有对齐、文本折行，用户自己就能觉察和规避，不影响正常使用；但有些异常，如交互逻辑错误、获取填充数据提交导致的脚本错误，会立刻终止用户的下一步操作，这类异常危害最大。用户不是开发者，不知道是什么问题导致脚本异常，甚至不知道已经发生了异常。我们主要抓取的，就是此类异常。

* 意义2：
	 
	在对被监控页面无侵入的前提下，提供7*24小时全天候的监控任务，第一时间发现“裸奔”、“半裸奔”页面或是有Javascript异常抛出的页面，并给网站前端负责人提供短信、邮件等方式的报警服务。
    可以说，前端异常监控系统主要是解决两大异常情况：
	a. 页面上有javascript异常  
	b. 各种因素造成的页面的样式丢失。

* 意义3：

	在 Web 应用异常复杂的今天，一个页面不单单只包含文字、图片和超链接，还可能包含复杂表单、大量动画、海量交互。很多 Web 应用完全单页化，操作体验、复杂程度堪比原生应用。这对开发者们来说，是巨大的挑战，纵然有 unit test、code review、各种黑白盒测试保价护航，也无法保证代码上线后，面对成千上万用户、在各类浏览器下、遇到未知数据时不出问题。所以，对一个拥有大量用户的互联网产品而言，一个可靠的前端异常数据采集、上报、处理、监控、报警平台是非常有必要的。



## 分析
## 目标定义

* 实现一套集前端异常数据采集、上报、存储、监控、预警为一体的前端异常监控平台。
* 针对线上真实用户真实场景的真实数据采集。
* 该平台本身的任何问题，保证不影响到实际业务功能，即使异常监控无法使用，亦不影响生产环境正常运行。

## 目标分析

* 异常采集功能
    * i)js原生异常采集：主要针对 window.error 在不同浏览器中存在的不同表现，需要数据统一
    * i)支持vue异常采集：需要研究vue框架异常报错的相关原理，同时需要考虑其他框架的异常采集的可拓展性
    * npm的引入方式写法，及paas链接引入方式写法
    * xhr异常采集：AOP技术，try...catch 使用
    * 资源异常采集：图片、CSS文件等等加载404的问题
    * 跨域js异常采集：需要配合服务器针对js文件请求的跨域放行，同时js标签添加crossorigin属性
    * 支持小程序异常采集：需要研究小程序异常报错的相关原理
    * 采集不同项目采用不同框架或类库的版本，如jquery,vue等等
    * 上报部分可以考虑自研/参考第三方开源
    * !!! 需要注意，网络报错无法获取
* 数据上报功能
    * i)上报频率限制
	* i)上报的方式：通过接口上报，参考badjs,利用 img 请求上报
	* 压缩需要上报的数据
	* 考虑采用http2相关技术，提高性能
	* 可自定义手动上报
	
* 数据处理功能
	* i)数据清洗，筛除不正确的数据
	* i)数据存储，使用mongodb存入数据
	* 实时监控功能，当有新的数据时，可以通过实时显示功能，在存储的同时显示到监控平台
* 异常监控功能
	* i)数据多维度展示，如：项目、时间、页面、技术栈（小程序/vuejs）及其版本
	* sourcemap支持：包括线下环境能够直接使用sourcemap
	* 异常回溯功能：复原异常操作，包括统计ajax上下文、操作上下文等，录制视频
	* 定期或不定期能够出报表
	* UI异常：定期自动抓取页面，比对是否存在CSS异常
* 异常预警功能
	* 配套实现邮件预警系统
	* 配套实现微信预警系统
	* 当且仅当触发某种设置的阈值之后会发起预警操作，如上述两种类型
* 其他
	* 考虑是否将性能相关的数据集成一起
	* 【测试部需求】监控资源大小，如给定一些图片的阈值，并能给出警告，以此来避免一些图片上传过大
	* 【测试部需求】能够在监控平台选择特定项目的特定页面，比如用户使用频率更高的 活动专题(市场运营)、视频/病例/专题(医生用户)
